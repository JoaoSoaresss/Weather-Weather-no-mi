<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Comparar Temperaturas</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="css/comparar.css">
</head>


<body class="bg-light">

  <!-- Top Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-4 py-3 shadow-sm">
    <div class="container-fluid">
      <button class="btn btn-primary me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar">
        <i class="bi bi-list fs-4"></i>
      </button>

      <a class="navbar-brand d-flex align-items-center gap-2 fs-4 m-0" href="index.html">
        <img src="img/logo/logo.png" alt="Logo" style="height: 50px;">
        <span class="d-none d-sm-inline">Weather Weather no Mi</span>
      </a>
      
      <div class="d-flex align-items-center ms-auto">
        <a href="index.html" class="btn btn-outline-light">
          <i class="bi bi-arrow-left me-1"></i>
          <span class="d-none d-md-inline">Voltar</span>
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
    <!-- Sidebar -->
  <div class="col-lg-2 p-0">
    <div class="offcanvas offcanvas-start bg-white border-end min-vh-100" tabindex="-1" id="sidebar">
      <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold">Menu</h5>
        <button type="button" class="btn-close x" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body p-3">
        <div class="nav flex-column gap-2">
          <a href="comparar.html" class="nav-link sidebar-item">
            <i class="bi bi-graph-up me-3 fs-5"></i>
            <span>Compare Temperatures</span>
          </a>
          <a href="admin.html" class="nav-link sidebar-item">
            <i class="bi bi-gear me-3 fs-5"></i>
            <span>Admin Panel</span>
          </a>
          <div class="nav-link sidebar-item" id="darkModeToggle" style="cursor: pointer;">
            <i class="bi bi-moon me-3 fs-5"></i>
            <span>Dark Mode</span>
          </div>
          <div class="dropdown">
            <a class="nav-link sidebar-item dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-calendar3 me-3 fs-5"></i>
              <span>Year: 2025</span>
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">2024</a></li>
              <li><a class="dropdown-item" href="#">2023</a></li>
              <li><a class="dropdown-item" href="#">2022</a></li>
            </ul>
          </div>
          <br>
          <div class="list-group" id="recent-locations"></div>
        </div>
      </div>
    </div>
  </div>

      <!-- Main Content -->
      <div class="container">
        <main class="mx-auto p-4" style="max-width: 900px;">
          <!-- Page Header -->
          <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="fw-bold mb-0">Comparar Cidades</h1>
            <div class="d-flex gap-2">
              <button class="btn btn-primary" id="compareBtn">
                <i class="bi bi-arrow-repeat me-1"></i> Comparar
              </button>
              <button class="btn btn-outline-secondary" id="exportBtn">
                <i class="bi bi-download me-1"></i> Exportar
              </button>
            </div>
          </div>

          <!-- Comparison Controls -->
          <div class="row g-4 mb-5">
            <div class="col-md-5">
              <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                  <h5 class="card-title fw-bold mb-4">Primeira Localização</h5>
                     
                  <div class="mb-4">
                    <label class="form-label fw-medium">Localização</label>
                    <input type="text" class="form-control" id="location1Input" placeholder="Ex: Lisboa, Paris">
                  </div>
                  
                  <div class="mb-4">
                    <label class="form-label fw-medium">Período</label>
                    <select class="form-select" id="location1Period">
                      <option value="today" selected>Hoje</option>
                      <option value="last7">Últimos 7 dias</option>
                      <option value="last30">Últimos 30 dias</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-2 d-flex align-items-center justify-content-center">
              <div class="vr d-none d-md-block" style="height: 300px;"></div>
              <div class="text-center d-md-none py-3">
                <i class="bi bi-arrow-down fs-4 text-muted"></i>
              </div>
            </div>
            
            <div class="col-md-5">
              <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                  <h5 class="card-title fw-bold mb-4">Segunda Localização</h5>
                  
                  <div class="mb-4">
                    <label class="form-label fw-medium">Localização</label>
                    <input type="text" class="form-control" id="location2Input" placeholder="Ex: Rio de Janeiro, Maringá">
                  </div>
                  
                  <div class="mb-4">
                    <label class="form-label fw-medium">Período</label>
                    <select class="form-select" id="location2Period">
                      <option value="today" selected>Hoje</option>
                      <option value="last7">Últimos 7 dias</option>
                      <option value="last30">Últimos 30 dias</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Comparison Results -->
          <div class="row mb-5">
            <div class="col-12">
              <div class="card shadow-sm border-0">
                <div class="card-body">
                  <h3 class="fw-bold mb-4">Comparação de Temperaturas</h3>
                  
                  <ul class="nav nav-tabs mb-4" id="comparisonTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart-tab-pane" type="button">Gráfico</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-tab-pane" type="button">Tabela</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-tab-pane" type="button">Estatísticas</button>
                    </li>
                  </ul>
                  
                  <div class="tab-content" id="comparisonTabsContent">
                    <div class="tab-pane fade show active" id="chart-tab-pane" role="tabpanel">
                      <div class="chart-container">
                        <canvas id="comparisonChart"></canvas>
                      </div>
                    </div>
                    
                    <div class="tab-pane fade" id="table-tab-pane" role="tabpanel">
                      <div class="table-responsive">
                        <table class="table table-hover" id="comparisonTable">
                          <thead>
                            <tr>
                              <th>Data</th>
                              <th id="location1Header">Local 1 Temp (°C)</th>
                              <th id="location2Header">Local 2 Temp (°C)</th>
                              <th>Diferença</th>
                            </tr>
                          </thead>
                          <tbody id="comparisonTableBody">
                            <!-- Data will be inserted here -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                    
                    <div class="tab-pane fade" id="stats-tab-pane" role="tabpanel">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="card mb-4">
                            <div class="card-body">
                              <h5 class="card-title fw-bold">Médias</h5>
                              <div class="row">
                                <div class="col-6">
                                  <div class="stat-card">
                                    <div class="stat-value text-primary" id="location1Avg">--°C</div>
                                    <div class="stat-label">Média Local 1</div>
                                  </div>
                                </div>
                                <div class="col-6">
                                  <div class="stat-card">
                                    <div class="stat-value text-danger" id="location2Avg">--°C</div>
                                    <div class="stat-label">Média Local 2</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="card mb-4">
                            <div class="card-body">
                              <h5 class="card-title fw-bold">Extremos</h5>
                              <div class="row">
                                <div class="col-6">
                                  <div class="stat-card">
                                    <div class="stat-value" id="location1Max">--°C</div>
                                    <div class="stat-label">Máx. Local 1</div>
                                  </div>
                                </div>
                                <div class="col-6">
                                  <div class="stat-card">
                                    <div class="stat-value" id="location2Max">--°C</div>
                                    <div class="stat-label">Máx. Local 2</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3">
    <div class="container">
      <p class="mb-0">Weather Weather no Mi © 2025 | Powered by OpenWeatherMap</p>
    </div>
  </footer>
    </div>
  </div>


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom JS -->
  <script>
    // Constants
    const METEOSTAT_API_KEY = 'b5e6fac024msh4fbd0aac517e9e9p12a443jsn443ddc1e63d6'; // Substitua pela sua chave
    const METEOSTAT_API_URL = 'https://meteostat.p.rapidapi.com';
    let comparisonChart = null;
    let location1Data = [];
    let location2Data = [];
    let location1Name = "";
    let location2Name = "";

    // DOM Elements
    const compareBtn = document.getElementById('compareBtn');
    const exportBtn = document.getElementById('exportBtn');
    const location1Input = document.getElementById('location1Input');
    const location2Input = document.getElementById('location2Input');
    const location1Period = document.getElementById('location1Period');
    const location2Period = document.getElementById('location2Period');
    const comparisonTableBody = document.getElementById('comparisonTableBody');
    const location1Header = document.getElementById('location1Header');
    const location2Header = document.getElementById('location2Header');
    const location1Avg = document.getElementById('location1Avg');
    const location2Avg = document.getElementById('location2Avg');
    const location1Max = document.getElementById('location1Max');
    const location2Max = document.getElementById('location2Max');

    // Obter coordenadas geográficas usando Nominatim (OpenStreetMap)
    async function obterCoordenadas(localizacao) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(localizacao)}&format=json&limit=1`);
        
        if (!response.ok) {
          throw new Error(`Erro na requisição: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data || data.length === 0) {
          throw new Error(`Localização "${localizacao}" não encontrada`);
        }
        
        return {
          lat: data[0].lat,
          lon: data[0].lon,
          displayName: data[0].display_name.split(',')[0]
        };
      } catch (error) {
        console.error('Erro ao obter coordenadas:', error);
        throw error;
      }
    }

    // Obter dados históricos da Meteostat
    async function obterDadosMeteostat(lat, lon, periodo) {
      try {
        const hoje = new Date();
        let startDate, endDate = hoje.toISOString().split('T')[0];
        
        switch(periodo) {
          case 'today':
            // Para dados de hoje, usamos o endpoint de dados horários
            return await obterDadosHoje(lat, lon);
          case 'last7':
            startDate = new Date(hoje);
            startDate.setDate(hoje.getDate() - 7);
            startDate = startDate.toISOString().split('T')[0];
            break;
          case 'last30':
            startDate = new Date(hoje);
            startDate.setDate(hoje.getDate() - 30);
            startDate = startDate.toISOString().split('T')[0];
            break;
          default:
            startDate = endDate;
        }
        
        const url = `${METEOSTAT_API_URL}/point/daily?lat=${lat}&lon=${lon}&start=${startDate}&end=${endDate}`;
        const options = {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': METEOSTAT_API_KEY,
            'X-RapidAPI-Host': 'meteostat.p.rapidapi.com'
          }
        };
        
        const response = await fetch(url, options);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Erro na requisição: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data || !data.data || data.data.length === 0) {
          throw new Error("Nenhum dado disponível para o período selecionado");
        }
        
        return data.data.map(item => ({
          date: item.date,
          temp: item.tavg || item.tmax, // Usa temperatura média ou máxima
          tmin: item.tmin,
          tmax: item.tmax
        }));
      } catch (error) {
        console.error('Erro ao obter dados da Meteostat:', error);
        throw error;
      }
    }

    // Obter dados do dia atual (horários)
    async function obterDadosHoje(lat, lon) {
      try {
        const hoje = new Date().toISOString().split('T')[0];
        const url = `${METEOSTAT_API_URL}/point/hourly?lat=${lat}&lon=${lon}&start=${hoje}&end=${hoje}`;
        const options = {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': METEOSTAT_API_KEY,
            'X-RapidAPI-Host': 'meteostat.p.rapidapi.com'
          }
        };
        
        const response = await fetch(url, options);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Erro na requisição: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data || !data.data || data.data.length === 0) {
          throw new Error("Nenhum dado disponível para hoje");
        }
        
        // Calcula médias do dia
        const temps = data.data.filter(item => item.temp !== null).map(item => item.temp);
        if (temps.length === 0) {
          throw new Error("Nenhum dado de temperatura disponível para hoje");
        }
        
        const avgTemp = temps.reduce((a, b) => a + b, 0) / temps.length;
        const minTemp = Math.min(...temps);
        const maxTemp = Math.max(...temps);
        
        return [{
          date: hoje,
          temp: parseFloat(avgTemp.toFixed(1)),
          tmin: parseFloat(minTemp.toFixed(1)),
          tmax: parseFloat(maxTemp.toFixed(1))
        }];
      } catch (error) {
        console.error('Erro ao obter dados de hoje:', error);
        throw error;
      }
    }

    // Comparar localizações
    async function compararLocalizacoes() {
      const localizacao1 = location1Input.value.trim();
      const localizacao2 = location2Input.value.trim();
      
      if (!localizacao1 || !localizacao2) {
        alert('Por favor, insira ambas as localizações para comparar.');
        return;
      }
      
      try {
        // Mostrar loading
        compareBtn.disabled = true;
        compareBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Carregando...';
        
        // Obter coordenadas e nomes das localizações
        const coords1 = await obterCoordenadas(localizacao1);
        const coords2 = await obterCoordenadas(localizacao2);
        
        location1Name = coords1.displayName;
        location2Name = coords2.displayName;
        
        // Obter dados para ambas as localizações
        const periodo1 = location1Period.value;
        const periodo2 = location2Period.value;
        
        location1Data = await obterDadosMeteostat(coords1.lat, coords1.lon, periodo1);
        location2Data = await obterDadosMeteostat(coords2.lat, coords2.lon, periodo2);
        
        // Atualizar UI
        atualizarGraficoComparacao();
        atualizarTabelaComparacao();
        atualizarEstatisticas();
      } catch (error) {
        console.error(error);
        alert(`Erro: ${error.message}`);
      } finally {
        // Restaurar botão
        compareBtn.disabled = false;
        compareBtn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Comparar';
      }
    }

    // Atualizar gráfico de comparação
    function atualizarGraficoComparacao() {
      const ctx = document.getElementById('comparisonChart').getContext('2d');
      
      // Preparar dados para o gráfico
      const labels = location1Data.map(item => item.date);
      const data1 = location1Data.map(item => item.temp);
      const data2 = location2Data.map(item => item.temp);
      
      // Destruir gráfico anterior se existir
      if (comparisonChart) {
        comparisonChart.destroy();
      }
      
      // Criar novo gráfico
      comparisonChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: location1Name,
              data: data1,
              borderColor: 'rgb(54, 162, 235)',
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              tension: 0.1,
              borderWidth: 2
            },
            {
              label: location2Name,
              data: data2,
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.5)',
              tension: 0.1,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Comparação de Temperaturas'
            },
          },
          scales: {
            y: {
              title: {
                display: true,
                text: 'Temperatura (°C)'
              },
              beginAtZero: false
            },
            x: {
              title: {
                display: true,
                text: 'Data'
              }
            }
          }
        }
      });
    }

    // Atualizar tabela de comparação
    function atualizarTabelaComparacao() {
      comparisonTableBody.innerHTML = '';
      
      // Atualizar cabeçalhos com os nomes das localizações
      location1Header.textContent = `${location1Name} Temp (°C)`;
      location2Header.textContent = `${location2Name} Temp (°C)`;
      
      // Encontrar datas comuns ou usar datas da localização 1
      const dates = location1Data.map(item => item.date);
      
      dates.forEach(date => {
        const loc1Item = location1Data.find(item => item.date === date);
        const loc2Item = location2Data.find(item => item.date === date);
        
        if (loc1Item) {
          const row = document.createElement('tr');
          
          // Se tivermos dados para ambas as localizações nesta data
          if (loc2Item) {
            const diff = (loc2Item.temp - loc1Item.temp).toFixed(1);
            const diffClass = diff > 0 ? 'text-danger' : diff < 0 ? 'text-success' : '';
            const diffSymbol = diff > 0 ? '+' : '';
            
            row.innerHTML = `
              <td>${date}</td>
              <td>${loc1Item.temp !== undefined ? loc1Item.temp.toFixed(1) : '--'}</td>
              <td>${loc2Item.temp !== undefined ? loc2Item.temp.toFixed(1) : '--'}</td>
              <td class="${diffClass}">${loc2Item.temp !== undefined ? diffSymbol + diff : '--'}</td>
            `;
          } else {
            // Apenas dados da localização 1
            row.innerHTML = `
              <td>${date}</td>
              <td>${loc1Item.temp !== undefined ? loc1Item.temp.toFixed(1) : '--'}</td>
              <td>--</td>
              <td>--</td>
            `;
          }
          
          comparisonTableBody.appendChild(row);
        }
      });
    }

    // Atualizar estatísticas
    function atualizarEstatisticas() {
      // Calcular médias
      const calcularMedia = dados => {
        const valores = dados.filter(item => item.temp !== undefined).map(item => item.temp);
        if (valores.length === 0) return '--';
        return (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(1);
      };
      
      // Calcular máximas
      const calcularMaxima = dados => {
        const valores = dados.filter(item => item.tmax !== undefined).map(item => item.tmax);
        if (valores.length === 0) return '--';
        return Math.max(...valores).toFixed(1);
      };
      
      // Atualizar UI
      location1Avg.textContent = `${calcularMedia(location1Data)}°C`;
      location2Avg.textContent = `${calcularMedia(location2Data)}°C`;
      location1Max.textContent = `${calcularMaxima(location1Data)}°C`;
      location2Max.textContent = `${calcularMaxima(location2Data)}°C`;
    }

    // Exportar dados como CSV
    function exportarDados() {
      if (location1Data.length === 0 || location2Data.length === 0) {
        alert('Por favor, faça uma comparação antes de exportar os dados.');
        return;
      }
      
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += `Data,${location1Name} Temp (°C),${location2Name} Temp (°C),Diferença\n`;
      
      const dates = location1Data.map(item => item.date);
      dates.forEach(date => {
        const loc1Item = location1Data.find(item => item.date === date);
        const loc2Item = location2Data.find(item => item.date === date);
        
        if (loc1Item) {
          const temp1 = loc1Item.temp !== undefined ? loc1Item.temp.toFixed(1) : '';
          const temp2 = loc2Item?.temp !== undefined ? loc2Item.temp.toFixed(1) : '';
          const diff = loc2Item?.temp !== undefined ? (loc2Item.temp - loc1Item.temp).toFixed(1) : '';
          
          csvContent += `${date},${temp1},${temp2},${diff}\n`;
        }
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `comparacao_${location1Name}_vs_${location2Name}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      compareBtn.addEventListener('click', compararLocalizacoes);
      exportBtn.addEventListener('click', exportarDados);
      
      // Permitir pressionar Enter nos campos de input
      [location1Input, location2Input].forEach(input => {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            compararLocalizacoes();
          }
        });
      });
    });
  </script>

<script src="js/comparar.js"></script>

</body>
</html>